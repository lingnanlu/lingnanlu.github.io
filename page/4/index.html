<!DOCTYPE html>



  


<html class="theme-next pisces use-motion" lang="zh-Hans">
<head><meta name="generator" content="Hexo 3.8.0">
  <meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform">
<meta http-equiv="Cache-Control" content="no-siteapp">
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css">







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css">

<link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=5.1.4">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.4" color="#222">





  <meta name="keywords" content="Hexo, NexT">










<meta name="keywords" content="Code, Food, Music">
<meta property="og:type" content="website">
<meta property="og:title" content="Code, Food &amp; Music">
<meta property="og:url" content="http://asanelder.me/page/4/index.html">
<meta property="og:site_name" content="Code, Food &amp; Music">
<meta property="og:locale" content="zh-Hans">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Code, Food &amp; Music">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Pisces',
    version: '5.1.4',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://asanelder.me/page/4/">





  <title>Code, Food & Music</title>
  








</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-left 
  page-home">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">Code, Food & Music</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle"></p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br>
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-user"></i> <br>
            
            关于
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br>
            
            标签
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br>
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br>
            
            归档
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://asanelder.me/2016/08/07/hashmap-loadfactor/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="asanelder">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Code, Food & Music">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2016/08/07/hashmap-loadfactor/" itemprop="url">HashMap中loadfactor的含义</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2016-08-07T00:00:00+08:00">
                2016-08-07
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>JDK文档中提到</p>
<blockquote>
<p>An instance of HashMap has two parameters that affect its performance: initial capacity and load factor. The capacity is the number of buckets in the hash table, and the initial capacity is simply the capacity at the time the hash table is created. The load factor is a measure of how full the hash table is allowed to get before its capacity is automatically increased. When the number of entries in the hash table exceeds the product of the load factor and the current capacity, the hash table is rehashed (that is, internal data structures are rebuilt) so that the hash table has approximately twice the number of buckets.</p>
<p>As a general rule, the default load factor (.75) offers a good tradeoff between time and space costs. Higher values decrease the space overhead but increase the lookup cost (reflected in most of the operations of the HashMap class, including get and put). The expected number of entries in the map and its load factor should be taken into account when setting its initial capacity, so as to minimize the number of rehash operations. If the initial capacity is greater than the maximum number of entries divided by the load factor, no rehash operations will ever occur.</p>
</blockquote>
<p>注意其中</p>
<blockquote>
<p>The load factor is a measure of how full the hash table is allowed to get before its capacity is automatically increased. </p>
</blockquote>
<p>但这句话到底是什么含义呢？</p>
<p>要想理解以上这句话，需要了解有关HashMap的其它几个术语</p>
<ol>
<li><strong>capacity</strong>：指桶的个数</li>
<li><strong>size</strong>：指Map中Entry的个数</li>
<li><strong>threshold</strong>：threshold = capacity * loadfactor, 含当size&gt;=threshold时， 增加capacity为原来的2倍（参考源代码）</li>
<li><strong>loadfactor</strong>: 含义是什么呢？ </li>
</ol>
<p>不妨通过一个例子来了解loadfactor的含义</p>
<p>假设capacity=10</p>
<ol>
<li><p>假设loadfactor=10, 由以上可知, 当size&gt;=(threshold = capacity * loadfactor)时扩容， 即size&gt;=100时扩容，<br>而此时只有10个桶， 可以看出， 每个桶都是比较满的。但扩容的速度比较慢</p>
</li>
<li><p>假设loadfactor=0.1,则size=1时扩容， 而此时有10个桶， 大多数桶还是很空的。但扩容的速度比较快。</p>
</li>
</ol>
<p>于是， 可以理解上文中那句话了。</p>
<h3 id="结论"><a href="#结论" class="headerlink" title="结论"></a>结论</h3><p>由上讨论可知</p>
<p>当loadfactor比较大时， 桶比较满， 空间占用比较少，扩容速率比较慢， rehash次数比较少, 但每个桶中元素比较多， 所以查找效率会低一些</p>
<p>当loadfactor比较少时， 桶比较空， 空间占用比较多，扩容速率比较快， rehash次数比较多， 查找效率会高一些</p>
<p>最终是在时间和空间中找到一个平衡</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://asanelder.me/2016/07/21/how-to-improve-system-tps/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="asanelder">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Code, Food & Music">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2016/07/21/how-to-improve-system-tps/" itemprop="url">如何提升一个系统的吞吐率</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2016-07-21T00:00:00+08:00">
                2016-07-21
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="零-名词解释"><a href="#零-名词解释" class="headerlink" title="零 名词解释"></a>零 名词解释</h2><p>组件：组成系统的各个部分</p>
<p>组件吞吐率：组件处理其输入的速率， 这里以秒为单位， 记作TPS(Tasks Per Second)</p>
<p>系统吞吐率：整个系统处理其输入的速率， 由组成该系统的组件决定， 依然使用TPS</p>
<h2 id="一-例子"><a href="#一-例子" class="headerlink" title="一 例子"></a>一 例子</h2><p>假设有一项Task需要分两步处理,由组件A处理第一步,组件B处理第二步</p>
<h3 id="1-原始"><a href="#1-原始" class="headerlink" title="1 原始"></a>1 原始</h3><p>最容易想到的方案如图1所示</p>
<p><img src="/assets/pics/TPS1.jpg" alt="TPS1"></p>
<p>假设组件A的吞吐率为10TPS,组件B的吞吐率为5TPS,那么,整个系统(将A, B看作一个整体)的吞吐率取决于B， 即5TPS。</p>
<p>而且， 因为A只能等B处理完了才能处理下一个, 所以A的实际吞吐率为5TPS.</p>
<h3 id="2-添加缓冲队列"><a href="#2-添加缓冲队列" class="headerlink" title="2 添加缓冲队列"></a>2 添加缓冲队列</h3><p>可以在A, B之间添加一个无穷队列作为缓冲, 如图2</p>
<p><img src="/assets/pics/TPS2.jpg" alt="TPS2"></p>
<p>这样就可以消除A等待B的情况, 提升A的吞吐率到10TPS. 但整个系统的吞吐率依然是5TPS</p>
<p><em>注：此时虽然A,B都在进行有效工作(即不存在一方等待另一方的情况),但整个吞吐率依然没有提升(所以单纯依靠缓存并非一定有效),但相比于之前的情况，A不会再因为B阻塞了，可以将Task插入到List后向客户端返回一个响应，这样对客户端来说，体验比较好，如小米抢手机时的请求排队。</em></p>
<h3 id="3-提升B的吞吐率"><a href="#3-提升B的吞吐率" class="headerlink" title="3 提升B的吞吐率"></a>3 提升B的吞吐率</h3><p>为了提升整个系统的吞吐率, 需要找到最慢的那一环节, 即B, 提升它的吞吐率, 可以有两种方式</p>
<ol>
<li>提升其本身的吞吐率</li>
<li>使用多个B</li>
</ol>
<p>这里我们使用使用两个B, 如下图3所示</p>
<p><img src="/assets/pics/TPS3.jpg" alt="TPS3"></p>
<p>现在两个B的吞吐率为10TPS, 和A匹配了, 现在整个系统的吞吐率达到了10TPS.</p>
<p>此时， 添加更好的B并不能提升整个系统的吞吐率， 所以说添加同一组件的多个复制并非越多越好， <strong>但此时有另外一个好处， 即如果一个B挂掉了， 那么还有另外的可用。所以可以布置2个以上的B，以防其中一个挂掉</strong>。</p>
<p>这种方案还有另外一种，即去掉A, B之间的队列， 由A直接将中间结果分发给B. 如图4</p>
<p><img src="/assets/pics/TPS4.jpg" alt="TPS4"></p>
<p><strong>图3和图4的区别仅仅是一个队列吗？</strong></p>
<p>实际上一个队列会带来很大的方便，假如我们现在要添加一个B.</p>
<p>对于图4来说， 因为A必须得知道B的存在(看图中的连线)， 所以添加一个B会影响到A(具体的系统中可能涉及到修改代码)</p>
<p>而对于图3来说， A只知道往中间队列中添加中间结果即可， 并不知道有多少个B的存在， 所以添加B会很方便.</p>
<p>不仅仅对于添加B来说， 对于修改或删除B也是同样的道理。</p>
<p>**所以通过这个中间队列， 就解耦了A与B之间的关系。</p>
<h3 id="4-多个组件结合成一个整体"><a href="#4-多个组件结合成一个整体" class="headerlink" title="4. 多个组件结合成一个整体"></a>4. 多个组件结合成一个整体</h3><p>但Tasks到达过快怎么办呢? 假如每秒到达20个, 那么系统现在每秒最多才能处理10个, 怎么办呢?</p>
<p>其实, 这个问题上文中已经解决了, 但这里需要做一点小小的抽象, 这样会发现, 这个问题并不是什么新的问题, 而是已经解决过的问题.</p>
<p>到底做怎么样的抽象呢?</p>
<p>这里有一个Tasks的到达速率, 我们可以想象Tasks是由另一个组件生产的, 这样Tasks的到达速率可以看成是该组件的吞吐率了. 我们为该组件起名为Dispatcher</p>
<p>然后, 将上文中提到的整个系统作为另一个组件， 称为Worker，该组件的吞率为10TPS。</p>
<p>于是，上面的问题就转化为了还是两个组件的速率不匹配的问题。于是可以利用之前的方法来解决。 就像下图这样</p>
<p><img src="/assets/pics/TPS5.jpg" alt="TPS5"></p>
<p><em>注：为了画图方便， 这里省略了队列， 队列产生的影响见上文</em></p>
<p>这里Dispatcher对Task不作处理， 其唯一的任务就是将Task分发给不同组件。</p>
<p>如果把Dispathcer和Worker看到一个整体,那么整个系统的吞吐率就是20TPS了.</p>
<p>很容易想到， 这种抽象可以一直这样进行下去， 将不同的组件当做一个整体看待， 从而可以一直提升系统的吞吐率。</p>
<h3 id="5-分解一个组件"><a href="#5-分解一个组件" class="headerlink" title="5. 分解一个组件"></a>5. 分解一个组件</h3><p>上面讨论到， 可以把多个组件组合成一个整体。这一节，向想反的方向探索-将一个组件分解为多个子组件。</p>
<p>这其实是可能的， 如果说一个组件是一个CPU的话， 我们可以将CPU的一个核当做一个子组件，这样一台服务器也可以看作是多个子组件组成的一个整体。</p>
<h2 id="二-这个例子不真实"><a href="#二-这个例子不真实" class="headerlink" title="二 这个例子不真实"></a>二 这个例子不真实</h2><p>上面的讨论似乎已经找到一种通用的思路来提升系统的吞吐率。</p>
<p>但忽略了一个很重要的地方。是什么呢？</p>
<p>上面的讨论是基本如下隐含的假设</p>
<blockquote>
<p>当一个组件处理完之后， 其结果能瞬间发送给下一个组件</p>
</blockquote>
<p>而事实并非如此</p>
<p>以图2为例， 当组件A处理完之后， 需要将结果发送给队列， 如果组件A与队列是两台不同机器的话， 那么这个发送要涉及网络IO, 在发送过程中， A什么也做不了。</p>
<p>同样， B需要等待A发来的数据， 如果数据来的很慢， 它也是什么都做不了。</p>
<h3 id="1-再看一个组件所做的工作"><a href="#1-再看一个组件所做的工作" class="headerlink" title="1. 再看一个组件所做的工作"></a>1. 再看一个组件所做的工作</h3><p>实现上一个组件所做的工作并不是仅仅处理数据， 还需要接收数据和发送数据， 确切的说由以下三部分组成</p>
<ol>
<li>等待其它组件发送过来的数据，作为输入</li>
<li>处理数据</li>
<li>将处理结果发送给下一步组件</li>
</ol>
<p>其中1, 3过程需要等待数据的接收和发送成功，在这个过程中并不处理数据，显然， 其用于1，3的时间越多， 该组件本身的吞吐率就越低。而且1，3本身只是同一问题的两个方面。如果发送的慢， 那么接收的肯定也慢。</p>
<p>那么如何减少1，3的时间呢？</p>
<h3 id="2-深入一个组件"><a href="#2-深入一个组件" class="headerlink" title="2. 深入一个组件"></a>2. 深入一个组件</h3><p>这里我们将组件看做是一台多核CPU的服务器。</p>
<p>先来解决<strong>将处理结果发送给下一步组件的问题</strong></p>
<p>如果即负责处理数据， 又负责发送数据， 那么发送数据会阻塞处理数据， 所以需要将两者分开。</p>
<p>可以利用一个核专门处理数据， 将结果写入到一个队列中去(此队列在内存中， 传输时间可忽略不计), 利用多个写线程负责从队列中取数据并写入网络(下一个组件是另一台服务器)，一个写线程阻塞的情况下， CPU可调度另一个写线程，至于写线程个数的确定请搜索<strong>IO密集型任务线程数确定</strong></p>
<p>再来看<strong>等待其它组件发送来的数据</strong></p>
<p>上文中提到， 使用多个写线程来发送数据， 这里多个写线程对于下一个组件来说就是多个数据来源(一般很少只接收一个数据来源， 这样如果该来源没有数据的话， 会造成严重的资源浪费)。</p>
<p>那么如何才能有效的接收多个来源的数据呢？</p>
<p>最简单的方法是等待一个数据来源的数据到达后，再去处理另一个数据来源， 用代码表示就是</p>
<pre><code>listenfd = open_listenfd(port);
while(true) {
    connfd = accept(listenfd);
    read(connfd);   //阻塞， 当数据到来后才能处理下一个连接
}
</code></pre><p>一个改进方法是， 使用多个读线程</p>
<pre><code>listenfd = open_listenfd(port);
while(true) {
    connfd = accept(listenfd);
    thread_create(connfd);
}
</code></pre><p>这样一个数据源的读取就不会阻塞另一个数据源了。这种方法的缺点就是可能产生大量线程(当需要长链接时，如聊天类应用)</p>
<p>另一种方法是使用selector监控多个数据源， 只要有数据源有数据到来就处理(当所有数据源没有数据时依然会阻塞)</p>
<p>以上三种方法可以使用如下的一个类比。</p>
<p><strong>人们排队打饭</strong></p>
<p>对于最简单的方案就是， 大家排成一队， 如果前面一个老太太掏钱(发送数据)很墨迹， 后面的人即使已经掏出了钱(准备好数据)也没用</p>
<p>对于多个读线程的方案就是， 大家排成一队， 来一个人就安排一个人专门负责处理， 这需要很多人(很多个线程)</p>
<p>对于selector方案， 大家不要排队，直接掏钱， 谁先掏出来， 就先打钣给谁。</p>
<h3 id="3-再看组件"><a href="#3-再看组件" class="headerlink" title="3 再看组件"></a>3 再看组件</h3><p>现在我们的组件不是那么简单了， 它包含很多核， 有的核负责读数据， 有的负责处理， 有的负责写数据， 一个组件现在看起来是图6这样的。该组件可以接收多个数据源， 并且可以产生多个数据源。队列用来进行线程间同步</p>
<p><img src="/assets/pics/TPS6.jpg" alt="TPS6"></p>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>由以上讨论可知， 以下原则</p>
<ol>
<li>一个系统各组件都在进行有效工作时， 该系统的效能并不一定到达其最高</li>
<li>简单的添加队列并不能提高其吞吐率，队列可能仅仅是为了作线程之间同步或简化程序逻辑</li>
<li>要想提高整个系统的吞吐率， 需要找到最慢的一节， 要么提升其吞吐率， 要么添加多个组件(添加多个组件还可能有效解决单点失效)</li>
<li>不要忽略数据的传输问题</li>
<li>dispatcher本质上来讲是一个分流器</li>
</ol>
<p>本文只是讨论了一种很简单的情况，但以上原则依然适用。需要具体问题， 具体分析</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://asanelder.me/2016/07/19/database-fundamental-concepts/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="asanelder">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Code, Food & Music">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2016/07/19/database-fundamental-concepts/" itemprop="url">数据库基础概念-索引，事务，日志，存储引擎</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2016-07-19T00:00:00+08:00">
                2016-07-19
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="零-前言"><a href="#零-前言" class="headerlink" title="零 前言"></a>零 前言</h2><p>自己这两天在处理一个问题时, 涉及到数据库的一些概念. 一直以来, 自己对数据库的知识也是蒙蒙懂懂(好吧, 本科就没认真学, 就了解一点SQL语句). 借此机会, 在网上查了些资料, 进一步了解了一些关键概念. 虽然理解的不深, 但比之前还是要好一些的. 担心自己过一段时间再次遗忘, 遂记录于此, 算是对这两天学习的总结吧.</p>
<p>这几个概念是</p>
<ol>
<li>索引</li>
<li>事务</li>
<li>日志</li>
<li>存储引擎</li>
</ol>
<h2 id="一-索引"><a href="#一-索引" class="headerlink" title="一 索引"></a>一 索引</h2><p>如果你在网上搜索”为什么需要索引”, 一般会得到如下答案</p>
<blockquote>
<p>索引是为了加快查找的速度, 但会导致数据库更新数据性能的下降</p>
</blockquote>
<p>But, why?</p>
<p>既然提到索引可以加快查找的速度, 那么首先得理解, 当查找一条record时, 到底发生了什么.</p>
<p>我们知道, 数据库以文件的形式保存数据, 而文件是以Block为单位保存在磁盘上, 为了有效利用磁盘空间, Block之间可能并不是连续保存的. 而为了查找文件中的数据, 需要先将Block交换到内存才行</p>
<p>假如我们有这样一个表</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> <span class="keyword">USER</span>(</span><br><span class="line">    <span class="keyword">string</span> <span class="keyword">name</span>,</span><br><span class="line">    <span class="built_in">int</span> age</span><br><span class="line">)</span><br><span class="line"><span class="string">``</span><span class="string">`   </span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">为了简单起见, 做以下假设</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">1. 该表由一个文件保存</span></span><br><span class="line"><span class="string">2. Block之间是以链表进行组织</span></span><br><span class="line"><span class="string">3. 磁盘和内存一次只能交换一个Block</span></span><br><span class="line"><span class="string">4. 该文件占用1024个Block</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">现在, 我们做如下查找</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">`</span><span class="string">``</span><span class="keyword">sql</span></span><br><span class="line"><span class="keyword">select</span> age <span class="keyword">from</span> <span class="keyword">USER</span> <span class="keyword">where</span> <span class="keyword">name</span>=<span class="string">"wade"</span></span><br></pre></td></tr></table></figure>
<p>那么, 由上讨论, 我们需要做平均512次磁盘IO才能找到目标, 而磁盘IO是很慢的.</p>
<p>而为某一列建立索引就是为了通过建立某种数据结构, 使得磁盘IO的次数可以降下来. 以下总结几种可能的方式, 及其可能存在的问题(并不限于此)</p>
<h3 id="1-索引的类型"><a href="#1-索引的类型" class="headerlink" title="1 索引的类型"></a>1 索引的类型</h3><h4 id="1-1-使用数组和Binary-Search"><a href="#1-1-使用数组和Binary-Search" class="headerlink" title="1.1 使用数组和Binary Search"></a>1.1 使用数组和Binary Search</h4><p>还是以上的例子, 如果说现在我有一个数组, 数组中的元素是这样子的</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">    <span class="built_in">string</span> name;</span><br><span class="line">    <span class="keyword">int</span> block_address;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>其中block_address为name为name的record所在的Block在磁盘上的地址(好吧, 有点绕)</p>
<p>而且该数组是以name进行从小到大排序的.</p>
<p>这样, 就可以使用Binary Search来查找数组, 进而找到所在的Block. 这个数组保存在磁盘上, 假如占据一个Block,则读入数据需要一次磁盘IO, 读入目标Block一次, 总共两次, 就可以找到了. </p>
<p>当然, 利用Binary Search的方法有个弊端(下面的二叉搜索树也存在这个问题), 如果说name列就有一种值, 那么查找数据的时候就无法确定哪一个Block包含目标, 所以依然需要读入很多次Block才行. 这只是一种极端情况, 但说明了,某一列可能包含的值的可能数越少, 此方法的效率就越低. <strong>所以选择在值的可能性多的那一列上做索引</strong>.</p>
<h4 id="1-2-使用二叉搜索树"><a href="#1-2-使用二叉搜索树" class="headerlink" title="1.2 使用二叉搜索树"></a>1.2 使用二叉搜索树</h4><p>这种方法与1中的类似, 因为二叉搜索树相对于插入, 删除操作效率更高一些(数组的插入, 删除需要平均移动一半的元素).</p>
<h4 id="1-3-B-B-树"><a href="#1-3-B-B-树" class="headerlink" title="1.3 B+, B-树"></a>1.3 B+, B-树</h4><p>上面的假设只是索引只占据一个Block, 可以一次读入内存, 但可以看到, 索引和数据量是正相关的, 当一个表很大时,可能索引本身也很大, 假设索引本身大到占用了1024个Block, 那么, 将索引本身读入内存进行查找也需要进行多次的磁盘IO.</p>
<p>最简单的方法是将索引的Block在磁盘组织成链表, 这样, 读入所有索引需要1024次磁盘IO, 显然效率不高.</p>
<p>而能不能将索引组织成二叉搜索树呢? 我们假设, 数中的结点对应一个Block, 而二叉搜索树的性质是一个结点只能有一个值, 而一个Block中显然有多个值. 当然, 我们可以一个Block只保存一个索引值, 那么一会造成Block的浪费, 二则这个树会很深, 而结点与Block对应, 很深意味着找到想要的索引可能需要读入很多次的Block. 为了充分利用Block和<br>二叉搜索树是二路搜索, 这里, 我们有多个值也就是多路,所以可以使用多路搜索树, 即B-, B+树</p>
<p>其中B-树是在所有结点中都保存了block_address, 而B+树中只有叶子结点保存了block_address, 非叶子结点只用来辅助找到最终的叶子结点. </p>
<p><strong>数据库的常用的是B+树, 而不是B-树. 为什么呢?</strong></p>
<p>因为B-树的结点中保存索引值也同时也保存了block_address, 而我们假设一个结点由一个Block保存, 这样, 一个Block中保存的索引值就少了, 而总的索引值又不变, 所以相对B+树来说, 需要的Block就更多, 潜在的需要磁盘IO的次数会更多.</p>
<h4 id="1-4-哈希索引"><a href="#1-4-哈希索引" class="headerlink" title="1.4 哈希索引"></a>1.4 哈希索引</h4><p>我们知道, 哈希也能加快查找数据的速度, 所以可以利用哈希表来实现索引, 看下如下的图就明白了.</p>
<p><img src="/assets/pics/hash_index.jpg" alt="hash_index"></p>
<h3 id="2-实现"><a href="#2-实现" class="headerlink" title="2 实现"></a>2 实现</h3><p>现在简单介绍一下MyISAM与InnoDB两种存储引擎中是如何实现的(至于什么是存储引擎, 暂时不管, 只要知道存储引擎和索引的实现相关就可以了)</p>
<h4 id="2-1-MyISAM"><a href="#2-1-MyISAM" class="headerlink" title="2.1 MyISAM"></a>2.1 MyISAM</h4><p>使用的是B+树, 叶节点存放的是数据记录的地址, 从图中可以看到, 索引是独立于数据文件存放的. 而且主键索引与辅助索引结构类似.</p>
<p>主键索引</p>
<p><img src="/assets/pics/myisam_primary_index.png" alt="myisam_primary_index"></p>
<p>辅助索引 </p>
<p><img src="/assets/pics/myisam_secondary_index.png" alt="myisam_secondary_index"></p>
<h4 id="2-2-InnoDB"><a href="#2-2-InnoDB" class="headerlink" title="2.2 InnoDB"></a>2.2 InnoDB</h4><p>同样使用B+树, 主键索引如下, 叶节点中存放的是数据记录本身. 所以说, 主键索引是与数据放在一起的.</p>
<p>主键索引</p>
<p><img src="/assets/pics/innodb_primary_index.png" alt="innodb_primary_index"></p>
<p>辅助索引如下, 叶节点中存放的是主键的值, 所以利用辅助索引查找时, 需要查找两次, 一次是根据辅助索引找到主键值, 再根据主键索引找到记录.</p>
<p>辅助索引</p>
<p><img src="/assets/pics/innodb_secondary_index.png" alt="innodb_secondary_index"></p>
<h4 id="2-3-聚集索引与非聚集索引"><a href="#2-3-聚集索引与非聚集索引" class="headerlink" title="2.3 聚集索引与非聚集索引"></a>2.3 聚集索引与非聚集索引</h4><p>这里顺便介绍一下这两个概念.</p>
<p>百度百科中提到这两者的区别</p>
<blockquote>
<p>聚集索引是指数据库表行中数据的物理顺序与键值的逻辑（索引）顺序相同。一个表只能有一个聚集索引，因为一个表的物理顺序只有一种情况，所以，对应的聚集索引只能有一个</p>
</blockquote>
<blockquote>
<p>非聚集索引是一种索引，该索引中索引的逻辑顺序与磁盘上行的物理存储顺序不同。</p>
</blockquote>
<p>好吧, 有点抽象, 其实理解了MyISAM与InnoDB的实现就很明白了.</p>
<p>InnoDB中的主键索引就是聚集索引, 因为数据和索引是放在一起存放的, 数据的存放方式只能有一种, 所以聚集索引也就只能有一下. </p>
<p>非聚集是说索引和数据分开放的, 所以可以有多个了.</p>
<p>这里的聚集含义可以理解为, 数据与索引是否在一起存放.</p>
<h3 id="3-总结"><a href="#3-总结" class="headerlink" title="3 总结"></a>3 总结</h3><p>通知以上可以知道, 索引就是通过建立某种数据结构, 并在其上实施某种算法, 以达到减少磁盘IO的目的(当然减少磁盘IO还可能有别的方法, 如缓存). </p>
<h3 id="4-补充"><a href="#4-补充" class="headerlink" title="4 补充"></a>4 补充</h3><ol>
<li>有人说索引是有序的, 这个不一定哈, 只要你想到一种结构能加块查找速度, 不管其有没有序(本文中提到的都是有序的)</li>
<li>默认会生成主键索引, 也就是说, 即使是不建立索引, 数据库也为你在主键上建立了一个索引(对于InnoDB, 倒是真的, 因为其主键索引和数据是混在一起保存的, 两者是不可分隔的整体, 其它的还有待确认)</li>
<li>索引是占据空间的, 这个显然</li>
<li>索引是需要维护的, 这个也显然</li>
<li>数据结构, 算法, 很重要</li>
</ol>
<h3 id="5-参考"><a href="#5-参考" class="headerlink" title="5 参考"></a>5 参考</h3><ol>
<li><a href="http://blog.csdn.net/hguisu/article/details/7786014" target="_blank" rel="noopener">B-树和B+树的应用：数据搜索和数据库索引</a></li>
<li><a href="http://stackoverflow.com/questions/1108/how-does-database-indexing-work" target="_blank" rel="noopener">How does database indexing work?</a></li>
<li><a href="http://imysql.com/2016/01/06/mysql-faq-different-between-btree-and-hash-index.shtml" target="_blank" rel="noopener">B+树索引和哈希索引的区别</a></li>
</ol>
<h2 id="二-事务-隔离性"><a href="#二-事务-隔离性" class="headerlink" title="二 事务-隔离性"></a>二 事务-隔离性</h2><blockquote>
<p>隔离性是目标, 达成目的还需要方法</p>
</blockquote>
<h3 id="1-定义"><a href="#1-定义" class="headerlink" title="1 定义"></a>1 定义</h3><p>隔离性：数据库允许多个并发事务同时对数据进行读写和修改的能力，隔离性可以防止多个事务并发执行时由于交叉执行而导致数据的不一致。事务隔离分为不同级别，包括读未提交（read uncommitted）、读提交（read committed）、可重复读（repeatable read）和串行化（Serializable）。</p>
<h3 id="2-隔离级别"><a href="#2-隔离级别" class="headerlink" title="2 隔离级别"></a>2 隔离级别</h3><p>按照由严到松的顺序, 如下(越松说明事务之间越可能产生影响)</p>
<p><strong>Serializable</strong>: 两个事务执行起来就像完全串行一样, 如T1, T2, 并发执行, 执行的效果就像T1-T2(或T2-T1, 两者的顺序无所谓, 反正最终结果是一样的)</p>
<p><strong>Repeatable reads</strong>: 一个事务多次读取一个数据, 读到的值都是一样的, 不可能多次读取的值不同(即在事务执行过程中, 读过的数据可能被其它事务所修改, 但即使是多次读到的值一样, 也不能保证数据没有被修改过, 可能修改之后, 又改回来了)</p>
<p><strong>Read committed</strong>:一个事务读到的数据如果是被其它事务访问过, 那么肯定是已提交的</p>
<p><strong>Read uncommitted</strong>:一个事务读到的数据可能是其它事务修改过但还未提交的.</p>
<h3 id="3-实现"><a href="#3-实现" class="headerlink" title="3 实现"></a>3 实现</h3><p>现在有两种流行的方法, 基于锁的和基于多版本控制的, 基于多版本控制的因为加锁少(或不加锁)其并发效率更好一些, 但因为要维护多个版本, 所以比较占空间. 以下给出两种方式的一些典型实现</p>
<ol>
<li><p>基于锁的</p>
<p><a href="https://www.wikiwand.com/en/Isolation_(database_systems" target="_blank" rel="noopener">locked-based isolation</a>)</p>
</li>
<li><p>基于多版本(MVCC Multiversion Concurrency Control)</p>
<p><a href="https://devcenter.heroku.com/articles/postgresql-concurrency" target="_blank" rel="noopener">PostgreSQL Concurrency with MVCC</a></p>
<p><a href="http://www.jasongj.com/sql/mvcc/index.html" target="_blank" rel="noopener">PostgreSQL针对ACID的实现机制</a></p>
<p><a href="http://blog.csdn.net/chen77716/article/details/6742128#comments" target="_blank" rel="noopener">Mysql中的MVCC</a></p>
</li>
</ol>
<h2 id="三-日志"><a href="#三-日志" class="headerlink" title="三 日志"></a>三 日志</h2><p>日志和事务的原子性与持久性有关</p>
<ul>
<li>原子性：一个事务（transaction）中的所有操作，要么全部完成，要么全部不完成，不会结束在中间某个环节。事务在执行过程中发生错误，会被回滚（Rollback）到事务开始前的状态，就像这个事务从来没有执行过一样。</li>
<li>持久性：事务处理结束后，对数据的修改就是永久的，即便系统故障也不会丢失。</li>
</ul>
<p>先简单注解一下<strong>原子性</strong>和<strong>持久性</strong></p>
<p><strong>什么是原子性</strong></p>
<p>比如一个事务是A给B转账100元, 需要从A的账户扣除100元, 并在B账户中添加100元. 无认在操作过程中发生什么情况如停电, 死机等(机器爆炸? 如果只有一台的话, 好吧, 这种情况不考虑), 那么执行这个事务只有两种结果</p>
<ol>
<li>转账成功(全部完成, A扣了100, B加了100)</li>
<li>转账失败(全部不完成, A没扣, B没加)</li>
</ol>
<p>绝对不允许出现</p>
<p>A扣了100, 但B没有加100</p>
<p>说起来容易, 做起来难, 这到底是怎么做到的呢? 万一执行了一半(A扣了100), 这时停电了, 那怎么保证只出现1, 2种情况呢?</p>
<p><strong>补充一点</strong>:事务就这两种结果, 如果成功, 正好满足用户的需要, 如果失败, 虽然用户的意图没有达到, 但用户也没有损失, 大不了重试就行了, 所以说, 这就是为什么事务要保障原子性的原因-失败的事务不会造成损失.</p>
<p><strong>什么是持久性</strong></p>
<blockquote>
<p>事务处理结束后，对数据的修改就是永久的，即便系统故障也不会丢失</p>
</blockquote>
<p>把这句话拆开来看</p>
<blockquote>
<p>事务处理结束后</p>
</blockquote>
<p>即执行了Commit语句后</p>
<blockquote>
<p>对数据的修改就是永久的，即便系统故障也不会丢失</p>
</blockquote>
<p>理解后半段有个背景知识. 数据库系统为了性能, 利用的缓存原理, 这样数据的修改就发生在内存中, 如果在将内存的数据写回磁盘之前, 停电了(属于系统故障), 那么内存中的修改不就丢失了吗? 数据的修改也就不是永久的了(保存在磁盘上算是永久)</p>
<h3 id="1-事务日志"><a href="#1-事务日志" class="headerlink" title="1 事务日志"></a>1 事务日志</h3><p>上文中保证提到了事务的两种性质, 需要由<strong>事务日志</strong>保证</p>
<p>假如系统运行良好, 原子性和持久性都没有问题.</p>
<p>所以<strong>事务日志</strong>起作用的地方, 就发生在系统故障的时候, 依然能保证原子性和持久性</p>
<p>事务日志的原理如下</p>
<blockquote>
<p>事务日志一般缓存在内存中, 事务每执行一条操作, 就记录一条日志, 当事务就执行Commit时,将日志写入到磁盘当中的日志文件去.</p>
</blockquote>
<p>就是这样简单的过程, 我们分析几种系统故障的情况, 看一看该过程是如何保证原子性和持久性的.</p>
<h4 id="1-1-在Commit之前停电-但日志未写入磁盘"><a href="#1-1-在Commit之前停电-但日志未写入磁盘" class="headerlink" title="1.1 在Commit之前停电, 但日志未写入磁盘"></a>1.1 在Commit之前停电, 但日志未写入磁盘</h4><p>此时, 事务未提交, 日志也没有写入到磁盘中, 内存中的修改和日志都丢失了, 有关系吗? 没关系, 因为事务没提交, 所以其所有的修改并没有写入到磁盘(只有Commit后才可能写入磁盘, 注意是可能, Commit后也不一定会写入磁盘, 为了性能). 所以该事务就想没发生过一样, 满足原子性</p>
<h4 id="1-2-在Commit之前停电-但日志写入磁盘"><a href="#1-2-在Commit之前停电-但日志写入磁盘" class="headerlink" title="1.2 在Commit之前停电, 但日志写入磁盘"></a>1.2 在Commit之前停电, 但日志写入磁盘</h4><p>只要事务没Commit, 该事务就一种结果, 全部不执行, 因为没Commit, 所以内存的修改丢失, 虽然日志写入磁盘, 但没什么用, 直接抛弃就好.</p>
<h4 id="1-3-Commit之后停电-数据还未写入磁盘"><a href="#1-3-Commit之后停电-数据还未写入磁盘" class="headerlink" title="1.3 Commit之后停电, 数据还未写入磁盘"></a>1.3 Commit之后停电, 数据还未写入磁盘</h4><p>Commit成功说明日志已经写入磁盘并且说明事务已完成, 那么所有的修改应该能出现在磁盘中, 虽然数据丢失了, 但有日志在, 所以重启后, 可以根据日志, 对所有丢失的操作进行redo, 这样就保证了只要是事务Commit了, 那么事务所做的操作一定全部执行并且数据持久化了.</p>
<p>由以上可知, 事条日志的确保证了事务的原子性与持久性.</p>
<h3 id="2-二进制日志"><a href="#2-二进制日志" class="headerlink" title="2 二进制日志"></a>2 二进制日志</h3><p>还有一种日志叫做二进制日志, 英文是binlog, 它和事务没关系, 所以其作用和原子性与持久性也不关. 它是用来恢复数据库和进行主从复制的.</p>
<p>该日志记录了所有与更新相关的操作. 利用此就可以恢复数据库和进行主从复制了</p>
<h4 id="2-1-恢复数据库"><a href="#2-1-恢复数据库" class="headerlink" title="2.1 恢复数据库"></a>2.1 恢复数据库</h4><p>假如该日志记录了2016.1.1日之后对数据库的所有操作, 现在是2016.7.1日, 有一个实习生把2016.2.1日之后的数据全删除了.</p>
<p>没关系, 因为此时数据库的数据是2016.2.1日那天的, 而我们又有2016.2.1到2016.7.1的所以操作, 在此数据库上重新执行操作即可</p>
<h4 id="2-2-主从复制"><a href="#2-2-主从复制" class="headerlink" title="2.2 主从复制"></a>2.2 主从复制</h4><p>这是用来进行数据库备份的.当然, 为了提高主从复制的性能有各种各样的方法, 反正又涉及到并发了, 这里就不深入下去了.</p>
<h3 id="3-其它"><a href="#3-其它" class="headerlink" title="3 其它"></a>3 其它</h3><p>当然,还有其它日志, 自己不了解, 暂时不提</p>
<h2 id="四-存储引擎"><a href="#四-存储引擎" class="headerlink" title="四 存储引擎"></a>四 存储引擎</h2><p>存储引擎就是数据库系统的一个组成部分, 它决定了</p>
<ol>
<li>数据库文件是如何存储的</li>
<li>索引的实现</li>
<li>事务的实现</li>
<li>其它(我不知道还有哪些)</li>
</ol>
<p>不同的存储引擎互有优劣, 选择哪个得在明白其原理的情况下具体问题, 具体分析, 对于MyISAM和InnoDB的取舍可参照以下文章中的结论.</p>
<p><a href="https://www.pureweber.com/article/myisam-vs-innodb/" target="_blank" rel="noopener">MySQL存储引擎MyISAM与InnoDB的优劣</a></p>
<h2 id="五-尾巴"><a href="#五-尾巴" class="headerlink" title="五 尾巴"></a>五 尾巴</h2><p>通过以上, 发现, 算法, 数据结构, 并发, 这些基础真的很重要. 自己有时间也需要对数据库的知识进行系统的学习.</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://asanelder.me/2016/06/02/attr-style-theme-best-practice/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="asanelder">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Code, Food & Music">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2016/06/02/attr-style-theme-best-practice/" itemprop="url">attr style theme 以及实践</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2016-06-02T00:00:00+08:00">
                2016-06-02
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="零、前言"><a href="#零、前言" class="headerlink" title="零、前言"></a>零、前言</h2><p>每当调整UI时，总是很迷糊，很多地方不明不白，有时需要android前缀， 有时又不需要。更改一个View的外观可以在layout中改，可以使用style，有时也可以使用?attr，还有的时候，还有的时候可以修改主题的某些属性，然后应用主题就可以了。</p>
<p>以上种种困扰着我，下面试着去理清这其中所涉及的种种概念，最后提出一种好的实践。</p>
<h2 id="一、attr"><a href="#一、attr" class="headerlink" title="一、attr"></a>一、attr</h2><h3 id="1-什么是attr"><a href="#1-什么是attr" class="headerlink" title="1. 什么是attr"></a>1. 什么是attr</h3><p>attr中文意思为属性，其类似于平时我们所定义的变量，有以下三个要素</p>
<ol>
<li>有一个名称</li>
<li>有类型</li>
<li>有值</li>
</ol>
<p>以上就是关于attr的全部了。</p>
<h3 id="2-定义和赋值的地方"><a href="#2-定义和赋值的地方" class="headerlink" title="2. 定义和赋值的地方"></a>2. 定义和赋值的地方</h3><p>既然attr类似与变量，就会有定义和赋值的地方，那么这两个地方在哪里？</p>
<p>首先说定义，定义是在一个叫attrs.xml的文件当中，形式类似与下面这样</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">attr</span> <span class="attr">name</span>=<span class="string">"hint"</span> <span class="attr">format</span>=<span class="string">"string"</span> /&gt;</span></span><br></pre></td></tr></table></figure>
<p>其中name说明了attr的名称，而format说明了attr的类型，可以是如下几种</p>
<ul>
<li>reference - if it references another resource id (e.g, * “@color/my_color”, “@layout/my_layout”)</li>
<li>color</li>
<li>boolean</li>
<li>dimension</li>
<li>float</li>
<li>integer</li>
<li>string</li>
<li>fraction</li>
<li>enum - normally implicitly defined</li>
<li>flag - normally implicitly defined</li>
</ul>
<p>flag说明值可以进行位或运算, reference说明其值是引用的另一个资源。</p>
<p>至于赋值的地方，这个就和attr的作用有关了，在下文中提及。</p>
<h3 id="3-attr的用途是什么？"><a href="#3-attr的用途是什么？" class="headerlink" title="3. attr的用途是什么？"></a>3. attr的用途是什么？</h3><p>好，既然我们定义了attr，那其总归是有用途的，它到底用来作什么呢？</p>
<p>其最明显的用途是用来设置View的属性，暂时抛开attr这个概念不谈，假如我们有一个Button控件，那么这个控件本身应该有一些属性吧，比如说背景颜色，文字大小，文字颜色等。而在Android系统中如何表现该控件的这些属性呢？显然我们就可以使用attr来表示。</p>
<p>如，我们可以这样定义一个Button应该有的属性</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">attr</span> <span class="attr">name</span>=<span class="string">"backgroundColor"</span> <span class="attr">format</span>=<span class="string">"color"</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">attr</span> <span class="attr">name</span>=<span class="string">"textColor"</span> <span class="attr">format</span>=<span class="string">"color"</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">attr</span> <span class="attr">name</span>=<span class="string">"textSize"</span> <span class="attr">format</span>=<span class="string">"dimension"</span> /&gt;</span></span><br></pre></td></tr></table></figure>
<p>然后在layout文件中对其进行赋值</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">Button</span></span></span><br><span class="line"><span class="tag">    <span class="attr">backgroundColor</span>=<span class="string">"#ffffff"</span></span></span><br><span class="line"><span class="tag">    <span class="attr">textColor</span>=<span class="string">"#000000"</span></span></span><br><span class="line"><span class="tag">    <span class="attr">textSize</span>=<span class="string">"25sp"</span></span></span><br><span class="line"><span class="tag">/&gt;</span></span><br></pre></td></tr></table></figure>
<p><em>注:以上代码并不规范，只是为了说明思想</em></p>
<p>在这里， 我们已经看到对属性赋值的一种方法，即在layout文件中直接赋值。当然不止这一种方式</p>
<h3 id="4-attr是如何影响到view外观的。"><a href="#4-attr是如何影响到view外观的。" class="headerlink" title="4. attr是如何影响到view外观的。"></a>4. attr是如何影响到view外观的。</h3><p>虽然我们定义的attr并在某个地方对其进行了赋值， 但其最终是如何影响到view的外观的呢？</p>
<p>可以从Google官方文档中<a href="https://developer.android.com/training/custom-views/index.html" target="_blank" rel="noopener">自定义view</a>找到一些线索。</p>
<p>大概是如下一个过程。</p>
<ol>
<li>某一个Parser读取xml文件，找到该View的属性值， 生成一个TypedArray结构</li>
<li>从TypedArray结构读取各个属性值， 赋值给某个成员变量</li>
<li>在onDraw()函数中利用这些属性值再进行实际的绘制。</li>
</ol>
<p>最关键的就是， attr并没有什么神奇， 只是被转化成onDraw进行绘制时的参数罢了。</p>
<h3 id="5-其它一些需要了解的地方"><a href="#5-其它一些需要了解的地方" class="headerlink" title="5. 其它一些需要了解的地方"></a>5. 其它一些需要了解的地方</h3><h4 id="5-1-找到某一个View支持的属性"><a href="#5-1-找到某一个View支持的属性" class="headerlink" title="5.1 找到某一个View支持的属性"></a>5.1 找到某一个View支持的属性</h4><p>如何知道某一个view支持的属性有哪些？方法有二</p>
<ol>
<li>查看官方文档，如 <a href="https://developer.android.com/reference/android/widget/Button.html" target="_blank" rel="noopener">Button</a></li>
<li>查看attrs.xml文件，系统自带的View也是view，其支持的属性也一定在attrs.xml文件中定义，只不过， 这个文件是SDK自带的， 而如果是我们自己自定义的view， 则需要在项目中自定义一个attrs.xml。要想找到系统的attrs.xml， 利用Android Studio的搜索功能就可以了， 注意对应的API版本。</li>
</ol>
<h4 id="5-2-属性属于同一命名空间与android前缀"><a href="#5-2-属性属于同一命名空间与android前缀" class="headerlink" title="5.2 属性属于同一命名空间与android前缀"></a>5.2 属性属于同一命名空间与android前缀</h4><p>对于某一包来说， 所有的属性都属于同一个命名空间。所以多个attr文件中的属性和同一文件中的属性， 不能同名不同类型。</p>
<p>平时我们在layout文件中为属性赋值时，有时需要加android前缀， 有时需要加app前缀，那么如何抉择呢？</p>
<p>如果是SDK中自带的attr就加android前缀， 如果是自定义的attr就加app前缀(当前这个名字可以是任意名称)，不同的前缀说明了其属于不同的命名空间。</p>
<p>举个例子， 如果一个自定义的View，继承了Button，并自定义了一些attr，那么， 为该View的attr赋值时， 类似于以下</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">CustomButton</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:textColor</span>=<span class="string">"#000000"</span></span></span><br><span class="line"><span class="tag">    <span class="attr">app:roundCorner</span>=<span class="string">true</span></span></span><br><span class="line"><span class="tag">/&gt;</span></span><br></pre></td></tr></table></figure>
<p><em>注， Support Appcompat其地位也是类似于自定义的View, 所以使用时， 依然需要app前缀</em></p>
<h4 id="5-3-declare-styleable"><a href="#5-3-declare-styleable" class="headerlink" title="5.3 declare-styleable"></a>5.3 declare-styleable</h4><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">declare-styleable</span> <span class="attr">name</span>=<span class="string">"PieChart"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">attr</span> <span class="attr">name</span>=<span class="string">"showText"</span> <span class="attr">format</span>=<span class="string">"boolean"</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">declare-styleable</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>首先， 属性都属于同一命名空间， 所以showText并不隶属于PieChart，那declare-styleable有什么作用呢？这里主要是用来组织一些attr， 并在代码中方便得到， 如</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">TypedArray a = context.getTheme().obtainStyledAttributes(</span><br><span class="line">   attrs,</span><br><span class="line">   R.styleable.PieChart,</span><br><span class="line">   <span class="number">0</span>, <span class="number">0</span>);</span><br></pre></td></tr></table></figure>
<p>当然， 属性也可以不属于declare-styleable</p>
<h4 id="5-4-没有format的attr"><a href="#5-4-没有format的attr" class="headerlink" title="5.4 没有format的attr"></a>5.4 没有format的attr</h4><p>在查看SDK中的attrs.xml时，发现有如下情况</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">declare-styleable</span> <span class="attr">name</span>=<span class="string">"TextView"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">attr</span> <span class="attr">name</span>=<span class="string">"textColor"</span> /&gt;</span></span><br></pre></td></tr></table></figure>
<p>发现有的attr没有format, 这是怎么回事呢? 这是因为该attr已经在之前定义过了，如果往上找可以发现</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">attr</span> <span class="attr">name</span>=<span class="string">"textColor"</span> <span class="attr">format</span>=<span class="string">"reference|color"</span> /&gt;</span></span><br></pre></td></tr></table></figure>
<p>而这个并不属于任何declare-styleable，所以如果有多个View需要相同的attr，他们有相同的format， 就可以在一处定义，在其他地方就可以不添加format了。</p>
<h2 id="二、style"><a href="#二、style" class="headerlink" title="二、style"></a>二、style</h2><h3 id="1-什么是style"><a href="#1-什么是style" class="headerlink" title="1. 什么是style"></a>1. 什么是style</h3><p>style的中文含义是样式，关注的是某一个View本身的外观。</p>
<p>当然以上解释还是有些模糊， 什么是样式呢？</p>
<p>当我们在一个应用中看到一个Button时，实际上这只是一个View，但是看起来像一个Button而已， 怎么做到看起来像呢？就是为这个View的各个attr设置一些值， 如backgroundColor,borderSize等赋值， 然后这个View看起来就像是一个Button了。</p>
<p>所以说style是一种抽象的概念，当我们说某一个View有个Button style时，实际上为了调整该View看起来像一个Button， 我们为该View的某些attr赋一些值。所以我们完全可将一个不是Button的View改成Button的外观。</p>
<p>现在也可以说style具体指什么了， 指的就是：</p>
<blockquote>
<p>为某些attr设置了值使之产生某中特定的视觉效果</p>
</blockquote>
<p>所以，style和attr的赋值有关。</p>
<h3 id="2-如何定义和使用style"><a href="#2-如何定义和使用style" class="headerlink" title="2. 如何定义和使用style"></a>2. 如何定义和使用style</h3><p>由上可知， 如果我们想要一个Button的外观， 那么直接在layout中为其attr设置一些属性值即可。如可以这样</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">TextView</span></span></span><br><span class="line"><span class="tag">    <span class="attr">background</span>=<span class="string">"@drawable/btn_default"</span></span></span><br><span class="line"><span class="tag">    <span class="attr">focusable</span>=<span class="string">"true"</span></span></span><br><span class="line"><span class="tag">    <span class="attr">clickable</span>=<span class="string">"true"</span></span></span><br><span class="line"><span class="tag">    <span class="attr">textAppearance</span>=<span class="string">"?attr/textAppearanceSmallInverse"</span></span></span><br><span class="line"><span class="tag">    <span class="attr">textColor</span>=<span class="string">"@color/primary_text_light"</span></span></span><br><span class="line"><span class="tag">    <span class="attr">gravity</span>=<span class="string">"center_vertical|center_horizontal"</span></span></span><br><span class="line"><span class="tag">/&gt;</span></span><br></pre></td></tr></table></figure>
<p>这样做有什么弊端呢？当我们需要多个TextView都有相同Button外观时，如果想要修改一下，则需要修改多处。 所以一种更好的方式是</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">style</span> <span class="attr">name</span>=<span class="string">"Widget.Button"</span>&gt;</span><span class="undefined"></span></span><br><span class="line"><span class="xml">    <span class="tag">&lt;<span class="name">item</span> <span class="attr">name</span>=<span class="string">"background"</span>&gt;</span>@drawable/btn_default<span class="tag">&lt;/<span class="name">item</span>&gt;</span></span></span><br><span class="line"><span class="xml">    <span class="tag">&lt;<span class="name">item</span> <span class="attr">name</span>=<span class="string">"focusable"</span>&gt;</span>true<span class="tag">&lt;/<span class="name">item</span>&gt;</span></span></span><br><span class="line"><span class="xml">    <span class="tag">&lt;<span class="name">item</span> <span class="attr">name</span>=<span class="string">"clickable"</span>&gt;</span>true<span class="tag">&lt;/<span class="name">item</span>&gt;</span></span></span><br><span class="line"><span class="xml">    <span class="tag">&lt;<span class="name">item</span> <span class="attr">name</span>=<span class="string">"textAppearance"</span>&gt;</span>?attr/textAppearanceSmallInverse<span class="tag">&lt;/<span class="name">item</span>&gt;</span></span></span><br><span class="line"><span class="xml">    <span class="tag">&lt;<span class="name">item</span> <span class="attr">name</span>=<span class="string">"textColor"</span>&gt;</span>@color/primary_text_light<span class="tag">&lt;/<span class="name">item</span>&gt;</span></span></span><br><span class="line"><span class="xml">    <span class="tag">&lt;<span class="name">item</span> <span class="attr">name</span>=<span class="string">"gravity"</span>&gt;</span>center_vertical|center_horizontal<span class="tag">&lt;/<span class="name">item</span>&gt;</span></span></span><br><span class="line"><span class="undefined"></span><span class="tag">&lt;/<span class="name">style</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>以上摘自SDK的styles.xml文件， 可见， 我们可以为一个Style起一个名字，这样当我们想将一个TextView设置为Button外观时， 可以这样</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">TextView</span></span></span><br><span class="line"><span class="tag">   <span class="attr">style</span>=<span class="string">"@android:style/Widget.Button"</span></span></span><br><span class="line"><span class="tag">/&gt;</span></span><br></pre></td></tr></table></figure>
<p><em>注：关于上面的@android:style以及?attr下文中会提到，暂时忽略</em></p>
<p>这样就方便了很多， 而且有一个有意义的名称。</p>
<p>当然， 我们使用Button时，并没有显示的设置其style， 实际上是利用了theme将ButtonStyle的外观对Button进行了设置， 至于如何设置的， 下文中讲到。</p>
<h3 id="3-SDK自带的style"><a href="#3-SDK自带的style" class="headerlink" title="3.SDK自带的style"></a>3.SDK自带的style</h3><p>有时我们需要定义某一种style，实际上并不需要自已来定义，SDK本身带了大量的style。</p>
<p>查看SDK都定义了哪些Style可以使用如下两种方法</p>
<ol>
<li><a href="https://developer.android.com/reference/android/R.style.html" target="_blank" rel="noopener">官方文档</a></li>
<li>源码， 使用Android Studio查找styles开头的文件，一般有多个， 如styles.xml, styles_material.xml, styles_device_defaults.xml等，<br>一般源码是更好的方式。</li>
</ol>
<h3 id="4-再谈style的定义"><a href="#4-再谈style的定义" class="headerlink" title="4. 再谈style的定义"></a>4. 再谈style的定义</h3><p>如果浏览SDK中的styles*.xml文件， 需要有三点需要注意的地方</p>
<ol>
<li><p>style可以继承另一个style:</p>
<p>继承方式有两种， 一种是显示的，指定parent 如</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">style</span> <span class="attr">name</span>=<span class="string">"TextAppearance.EasyCorrectSuggestion   parent="</span><span class="attr">TextAppearance.Suggestion</span>"&gt;</span><span class="undefined"></span></span><br><span class="line"><span class="xml">     <span class="tag">&lt;<span class="name">item</span> <span class="attr">name</span>=<span class="string">"textUnderlineColor"</span>&gt;</span>#88C8C8C8<span class="tag">&lt;/<span class="name">item</span>&gt;</span></span></span><br><span class="line"><span class="undefined"></span><span class="tag">&lt;/<span class="name">style</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>另一种是隐式的， 通过名称可以知道父style， 如以下TextAppearance.Inverse就继承了TextAppearance</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">style</span> <span class="attr">name</span>=<span class="string">"TextAppearance"</span>&gt;</span><span class="undefined"></span></span><br><span class="line"><span class="xml">    <span class="tag">&lt;<span class="name">item</span> <span class="attr">name</span>=<span class="string">"textColor"</span>&gt;</span>?textColorPrimary<span class="tag">&lt;/<span class="name">item</span>&gt;</span></span></span><br><span class="line"><span class="xml">    <span class="tag">&lt;<span class="name">item</span> <span class="attr">name</span>=<span class="string">"textColorHighlight"</span>&gt;</span>    textColorHighlight<span class="tag">&lt;/<span class="name">item</span>&gt;</span></span></span><br><span class="line"><span class="xml">    <span class="tag">&lt;<span class="name">item</span> <span class="attr">name</span>=<span class="string">"textColorHint"</span>&gt;</span>?textColorHint<span class="tag">&lt;/<span class="name">item</span>&gt;</span></span></span><br><span class="line"><span class="xml">    <span class="tag">&lt;<span class="name">item</span> <span class="attr">name</span>=<span class="string">"textColorLink"</span>&gt;</span>?textColorLink<span class="tag">&lt;/<span class="name">item</span>&gt;</span></span></span><br><span class="line"><span class="xml">    <span class="tag">&lt;<span class="name">item</span> <span class="attr">name</span>=<span class="string">"textSize"</span>&gt;</span>16sp<span class="tag">&lt;/<span class="name">item</span>&gt;</span></span></span><br><span class="line"><span class="xml">    <span class="tag">&lt;<span class="name">item</span> <span class="attr">name</span>=<span class="string">"textStyle"</span>&gt;</span>normal<span class="tag">&lt;/<span class="name">item</span>&gt;</span></span></span><br><span class="line"><span class="undefined"></span><span class="tag">&lt;/<span class="name">style</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">style</span> <span class="attr">name</span>=<span class="string">"TextAppearance.Inverse"</span>&gt;</span><span class="undefined"></span></span><br><span class="line"><span class="xml">    <span class="tag">&lt;<span class="name">item</span> <span class="attr">name</span>=<span class="string">"textColor"</span>&gt;</span>?textColorPrimaryInverse<span class="tag">&lt;/<span class="name">item</span>&gt;</span></span></span><br><span class="line"><span class="xml">    <span class="tag">&lt;<span class="name">item</span> <span class="attr">name</span>=<span class="string">"textColorHint"</span>&gt;</span>?textColorHintInverse<span class="tag">&lt;/<span class="name">item</span>&gt;</span></span></span><br><span class="line"><span class="xml">    <span class="tag">&lt;<span class="name">item</span> <span class="attr">name</span>=<span class="string">"textColorHighlight"</span>&gt;</span>?   textColorHighlightInverse<span class="tag">&lt;/<span class="name">item</span>&gt;</span></span></span><br><span class="line"><span class="xml">    <span class="tag">&lt;<span class="name">item</span> <span class="attr">name</span>=<span class="string">"textColorLink"</span>&gt;</span>?textColorLinkInverse<span class="tag">&lt;/<span class="name">item</span>&gt;</span></span></span><br><span class="line"><span class="undefined"></span><span class="tag">&lt;/<span class="name">style</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>有一个需要注意的地方是， 如果我们自已定义一个style，显示继承SDK中的style， 则需要android前缀， 因为不在一个包内， 而SDK中的则不需要，因为在一个包内。如</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">style</span> <span class="attr">name</span>=<span class="string">"CustomStyle"</span> <span class="attr">parent</span>=<span class="string">"@android:style/parent&gt;</span></span></span><br></pre></td></tr></table></figure>
</li>
<li><p>attr赋值</p>
<p>attr都有format，对与不同的format，则需要赋不同类型的值。如对于以下属性</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">attr</span> <span class="attr">name</span>=<span class="string">"textColor"</span> <span class="attr">format</span>=<span class="string">"reference|color"</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">attr</span> <span class="attr">name</span>=<span class="string">"textSize"</span> <span class="attr">format</span>=<span class="string">"dimension"</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">attr</span> <span class="attr">name</span>=<span class="string">"shadowColor"</span> <span class="attr">format</span>=<span class="string">"color"</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">attr</span> <span class="attr">name</span>=<span class="string">"shadowDx"</span> <span class="attr">format</span>=<span class="string">"float"</span> /&gt;</span>    </span><br><span class="line"><span class="tag">&lt;<span class="name">attr</span> <span class="attr">name</span>=<span class="string">"shadowDy"</span> <span class="attr">format</span>=<span class="string">"float"</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">attr</span> <span class="attr">name</span>=<span class="string">"shadowRadius"</span> <span class="attr">format</span>=<span class="string">"float"</span> /&gt;</span></span><br></pre></td></tr></table></figure>
<p>有一个Style如下</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">style</span> </span></span><br><span class="line"><span class="tag"><span class="attr">name</span>=<span class="string">"TextAppearance.SlidingTabNormal"</span> </span></span><br><span class="line"><span class="tag"><span class="attr">parent</span>=<span class="string">"TextAppearance.Medium"</span>&gt;</span><span class="undefined"></span></span><br><span class="line"><span class="xml">     <span class="tag">&lt;<span class="name">item</span> <span class="attr">name</span>=<span class="string">"textColor"</span>&gt;</span>?attr/textColorTertiary<span class="tag">&lt;/<span class="name">item</span>&gt;</span></span></span><br><span class="line"><span class="xml">     <span class="tag">&lt;<span class="name">item</span> <span class="attr">name</span>=<span class="string">"textSize"</span>&gt;</span>28sp<span class="tag">&lt;/<span class="name">item</span>&gt;</span></span></span><br><span class="line"><span class="xml">     <span class="tag">&lt;<span class="name">item</span> <span class="attr">name</span>=<span class="string">"shadowColor"</span>&gt;</span>@color/sliding_tab_text_color_shadow<span class="tag">&lt;<span class="name">item</span>&gt;</span></span></span><br><span class="line"><span class="xml">     <span class="tag">&lt;<span class="name">item</span> <span class="attr">name</span>=<span class="string">"shadowDx"</span>&gt;</span>0.0<span class="tag">&lt;/<span class="name">item</span>&gt;</span></span></span><br><span class="line"><span class="xml">     <span class="tag">&lt;<span class="name">item</span> <span class="attr">name</span>=<span class="string">"shadowDy"</span>&gt;</span>1.0<span class="tag">&lt;/<span class="name">item</span>&gt;</span></span></span><br><span class="line"><span class="xml">     <span class="tag">&lt;<span class="name">item</span> <span class="attr">name</span>=<span class="string">"shadowRadius"</span>&gt;</span>5.0<span class="tag">&lt;/<span class="name">item</span>&gt;</span></span></span><br><span class="line"><span class="undefined"></span><span class="tag">&lt;/<span class="name">style</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>有一个奇怪的地方</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">item</span> <span class="attr">name</span>=<span class="string">"textColor"</span>&gt;</span>?attr/textColorTertiary<span class="tag">&lt;/<span class="name">item</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>这是什么含义呢？这里的含义指的是textColor的值使用的是当前theme中定义的textColorTertiary属性的值。下文中讲theme是会提到，theme和style类似，也是为一些属性进行了赋值，而且在其它地方可以使用<strong>?attr</strong>来引用这些属性值(如果不在一个包内,则需要使用<strong>?android:attr</strong>，加android前缀，说明是使用SDK中的theme中attr。)</p>
</li>
<li><p>命名规范</p>
<p>为Style起名字也需要一定的格式，遵循好的规范有利于对style的使用,后文提到</p>
</li>
</ol>
<h2 id="三、theme"><a href="#三、theme" class="headerlink" title="三、theme"></a>三、theme</h2><h3 id="1-什么是theme"><a href="#1-什么是theme" class="headerlink" title="1. 什么是theme"></a>1. 什么是theme</h3><p>theme的中文含义是主题，关注的是一种整体的感觉。</p>
<p>那么什么是整体的感觉呢？ 当我们说style时，往往指的是某一个局部view的style, 而我们说theme时， 指的是整个app中， 颜色的一致性，文字大小的一致性， 各个View看起来属于同一类别，比如都是Material风格的等等，总之，让你感觉到，你所看到的各个View是属于某一App的，简单的来说，要达到和谐的效果。</p>
<h3 id="2-到底如何达到一种整体的感觉"><a href="#2-到底如何达到一种整体的感觉" class="headerlink" title="2. 到底如何达到一种整体的感觉"></a>2. 到底如何达到一种整体的感觉</h3><p>先抛开theme，现在我们有一个目标， 设计一个界面， 是Material风格的，既界面上的组件都得是Material风格的。</p>
<p>假设该界面上有如下组件。</p>
<p>2个Button<br>2个Spinner<br>1个Tab</p>
<p>首先我们为每一类组件定义一种Material style</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">style</span> <span class="attr">name</span>=<span class="string">"Widget.Material.Tab"</span>&gt;</span><span class="undefined"></span></span><br><span class="line"><span class="xml"><span class="tag">&lt;<span class="name">style</span> <span class="attr">name</span>=<span class="string">"Widget.Material.Spinner"</span>&gt;</span><span class="undefined"></span></span></span><br><span class="line"><span class="xml"><span class="tag">&lt;<span class="name">style</span> <span class="attr">name</span>=<span class="string">"Widget.Material.Button"</span>&gt;</span><span class="undefined"></span></span></span><br></pre></td></tr></table></figure>
<p>在layout文件中， 我们可以这样指定其样式</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">Button</span></span></span><br><span class="line"><span class="tag">    <span class="attr">id</span>=<span class="string">"button_1"</span></span></span><br><span class="line"><span class="tag">    <span class="attr">style</span>=<span class="string">"@style/Widget.Material.Button"</span></span></span><br><span class="line"><span class="tag">/&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">Button</span></span></span><br><span class="line"><span class="tag">    <span class="attr">id</span>=<span class="string">"button_2"</span></span></span><br><span class="line"><span class="tag">    <span class="attr">style</span>=<span class="string">"@style/Widget.Material.Button"</span></span></span><br><span class="line"><span class="tag">/&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">Spinner</span></span></span><br><span class="line"><span class="tag">    <span class="attr">id</span>=<span class="string">"spinner_1"</span></span></span><br><span class="line"><span class="tag">    <span class="attr">style</span>=<span class="string">"@style/Widget.Material.Spinner"</span></span></span><br><span class="line"><span class="tag">/&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">Spinner</span></span></span><br><span class="line"><span class="tag">    <span class="attr">id</span>=<span class="string">"spinner_2"</span></span></span><br><span class="line"><span class="tag">    <span class="attr">style</span>=<span class="string">"@style/Widget.Material.Spinner"</span></span></span><br><span class="line"><span class="tag">/&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">Tab</span></span></span><br><span class="line"><span class="tag">    <span class="attr">id</span>=<span class="string">"tab_1"</span></span></span><br><span class="line"><span class="tag">    <span class="attr">style</span>=<span class="string">"@style/Widget.Material.Tab"</span></span></span><br><span class="line"><span class="tag">/&gt;</span></span><br></pre></td></tr></table></figure>
<p>好了， 这个界面算是Material风格的了， 如果有其它界面， 我们也这样设置就行。</p>
<p>但是， 如果我们想为App换一种风格，比如说Holo风格， 那么怎么办呢？要修改每一个组件的Style吗？岂不很麻烦？</p>
<p>此时， 就是Theme发挥作用的地方了。</p>
<p>我们在Application或Activity指定Theme就可以使得整个App或某一Activity有着某一整体风格了， 如</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">application</span> </span></span><br><span class="line"><span class="tag">    <span class="attr">theme</span>=<span class="string">“@style/Theme.Material</span>"</span></span><br><span class="line"><span class="tag">/&gt;</span></span><br></pre></td></tr></table></figure>
<p>这样就OK了。如果换成另一风格， 只要</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">application</span> </span></span><br><span class="line"><span class="tag">    <span class="attr">theme</span>=<span class="string">“@style/Theme.Holo</span>"</span></span><br><span class="line"><span class="tag">/&gt;</span></span><br></pre></td></tr></table></figure>
<p>当为application或activity应用某一theme时，会依次查看该Activity对应View树中的每个节点是否支持Theme中定义的attr， 支持就应用， 不支持就忽略， 而对于style来说， 只是查看应用该style的节点是否支持。</p>
<p>注意， 这里的支持指的是View的构造函数中真正读取的attr，下文中Button以及buttonStyle就是一个例子。</p>
<p>但这是如何做到的呢？</p>
<h3 id="3-theme中为哪些属性进行了赋值？"><a href="#3-theme中为哪些属性进行了赋值？" class="headerlink" title="3. theme中为哪些属性进行了赋值？"></a>3. theme中为哪些属性进行了赋值？</h3><p>由上一节结尾</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">application</span> </span></span><br><span class="line"><span class="tag">    <span class="attr">theme</span>=<span class="string">“@style/Theme.Material</span>"</span></span><br><span class="line"><span class="tag">/&gt;</span></span><br></pre></td></tr></table></figure>
<p>发现Theme其实也是一种Style，只是名称以Theme开头罢了，既然也是一种Style， 那么也是为一些attr赋值。那么为哪些attr赋值呢？</p>
<p>因为我们知道style一般为某一Widget设置样式，所以设置的attr一般是该Widget支持的attr，但theme似乎要为各种各样的widget设置样式，而不同widget的attr也不尽相同，难道在要theme中为所有可能的attr赋值吗？</p>
<p>我们来看系统自带的Theme是如何做的，首先要找到系统自带的Theme， 有两种方式</p>
<ol>
<li><a href="https://developer.android.com/reference/android/R.style.html" target="_blank" rel="noopener">官方文档</a>, 因为theme也是一种style，所以也在R.style中</li>
<li>源码：使用Android Studio搜索themes.xml就可以看到好几个， 打开一个看， 发现与styles.xml中的结构相同，这也说明theme就是一种style.</li>
</ol>
<p>以themes.xml中Theme为例，在这里讨论几种attr</p>
<h4 id="3-1-与Widget相关"><a href="#3-1-与Widget相关" class="headerlink" title="3.1 与Widget相关"></a>3.1 与Widget相关</h4><p>查看其中的一条</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">item</span> <span class="attr">name</span>=<span class="string">"buttonStyle"</span>&gt;</span>@style/Widget.Button<span class="tag">&lt;/<span class="name">item</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>看名称似乎和Button的样式有关，而且其值是一个Style，那么该属性值是如何应用到Button上的呢？</p>
<p>如果我查看官方文档，发现Button并没有这个attr，查看attrs.xml中也没有发现Button支持这个attr, 既然Button都不支持buttonStyle这个属性， 那么怎么会影响到Button外观呢？</p>
<p>其实别忘记了， attr到底是怎样影响到View的外观的，在第一部分已经讨论了，attr只是定义了一些键值对， 而这些键值对要在View的构造函数中读入， 并在onDraw()中使用，仅仅如此。</p>
<p>如果我们去看Button的源代码，就会发现</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">Button</span><span class="params">(Context context, AttributeSet attrs)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">this</span>(context, attrs, com.android.internal.R.attr.buttonStyle);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>看到buttonStyle了吧， 这里会将buttonStyle中引用的style展开， 查看Widget.Button</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">style</span> <span class="attr">name</span>=<span class="string">"Widget.Button"</span>&gt;</span><span class="undefined"></span></span><br><span class="line"><span class="xml">    <span class="tag">&lt;<span class="name">item</span> <span class="attr">name</span>=<span class="string">"background"</span>&gt;</span>@drawable/btn_default<span class="tag">&lt;/<span class="name">item</span>&gt;</span></span></span><br><span class="line"><span class="xml">    <span class="tag">&lt;<span class="name">item</span> <span class="attr">name</span>=<span class="string">"focusable"</span>&gt;</span>true<span class="tag">&lt;/<span class="name">item</span>&gt;</span></span></span><br><span class="line"><span class="xml">    <span class="tag">&lt;<span class="name">item</span> <span class="attr">name</span>=<span class="string">"clickable"</span>&gt;</span>true<span class="tag">&lt;/<span class="name">item</span>&gt;</span></span></span><br><span class="line"><span class="xml">    <span class="tag">&lt;<span class="name">item</span> <span class="attr">name</span>=<span class="string">"textAppearance"</span>&gt;</span>?attr/textAppearanceSmallInverse<span class="tag">&lt;/<span class="name">item</span>&gt;</span></span></span><br><span class="line"><span class="xml">    <span class="tag">&lt;<span class="name">item</span> <span class="attr">name</span>=<span class="string">"textColor"</span>&gt;</span>@color/primary_text_light<span class="tag">&lt;/<span class="name">item</span>&gt;</span></span></span><br><span class="line"><span class="xml">    <span class="tag">&lt;<span class="name">item</span> <span class="attr">name</span>=<span class="string">"gravity"</span>&gt;</span>center_vertical|center_horizontal<span class="tag">&lt;/<span class="name">item</span>&gt;</span></span></span><br><span class="line"><span class="undefined"></span><span class="tag">&lt;/<span class="name">style</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>这里的属性就是Button直接支持的attr了。</p>
<p>以上这类theme中定义的attr还有很多，主要是定义Widget的外观，如</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- Widget styles --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">item</span> <span class="attr">name</span>=<span class="string">"absListViewStyle"</span>&gt;</span>@style/Widget.AbsListView<span class="tag">&lt;/<span class="name">item</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">item</span> <span class="attr">name</span>=<span class="string">"autoCompleteTextViewStyle"</span>&gt;</span>@style/Widget.AutoCompleteTextView<span class="tag">&lt;<span class="name">item</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">item</span> <span class="attr">name</span>=<span class="string">"checkboxStyle"</span>&gt;</span>@style/Widget.CompoundButton.CheckBox<span class="tag">&lt;/<span class="name">item</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">item</span> <span class="attr">name</span>=<span class="string">"checkedTextViewStyle"</span>&gt;</span>@style/Widget.CheckedTextView<span class="tag">&lt;/<span class="name">item</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">item</span> <span class="attr">name</span>=<span class="string">"dropDownListViewStyle"</span>&gt;</span>@style/Widget.ListView.DropDown<span class="tag">&lt;/<span class="name">item</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">item</span> <span class="attr">name</span>=<span class="string">"editTextStyle"</span>&gt;</span>@style/Widget.EditText<span class="tag">&lt;/<span class="name">item</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">item</span> <span class="attr">name</span>=<span class="string">"expandableListViewStyle"</span>&gt;</span>@style/Widget.ExpandableListView<span class="tag">&lt;<span class="name">item</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">item</span> <span class="attr">name</span>=<span class="string">"expandableListViewWhiteStyle"</span>&gt;</span>@styleWidget.ExpandableListView.White<span class="tag">&lt;/<span class="name">item</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">item</span> <span class="attr">name</span>=<span class="string">"fastScrollStyle"</span>&gt;</span>@style/Widget.FastScroll<span class="tag">&lt;/<span class="name">item</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">item</span> <span class="attr">name</span>=<span class="string">"galleryStyle"</span>&gt;</span>@style/Widget.Gallery<span class="tag">&lt;/<span class="name">item</span>&gt;</span></span><br></pre></td></tr></table></figure>
<h4 id="3-2-只用来被其它attr引用的属性"><a href="#3-2-只用来被其它attr引用的属性" class="headerlink" title="3.2 只用来被其它attr引用的属性"></a>3.2 只用来被其它attr引用的属性</h4><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">item</span> <span class="attr">name</span>=<span class="string">"textColorPrimary"</span>&gt;</span>@color/primary_text_dark<span class="tag">&lt;/<span class="name">item</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>从名称上来看，该属性是用来设置text的颜色的，但是查询attrs.xml发现， 该属性不属于任何Widget，是一个全局的属性。查看各Widget的源码文件，也没有发现在源码文件中读取该attr值的地方。</p>
<p>那么它怎么就能影响到text的颜色了呢？</p>
<p>其实很简单，该attr并不是直接影响text的颜色， 而是被其它attr引用后，间接影响text的颜色，如果查看styles.xml文件，发现如下片段</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">style</span> <span class="attr">name</span>=<span class="string">"TextAppearance"</span>&gt;</span><span class="undefined"></span></span><br><span class="line"><span class="xml">    <span class="tag">&lt;<span class="name">item</span> <span class="attr">name</span>=<span class="string">"textColor"</span>&gt;</span>?textColorPrimary<span class="tag">&lt;/<span class="name">item</span>&gt;</span></span></span><br><span class="line"><span class="xml">    <span class="tag">&lt;<span class="name">item</span> <span class="attr">name</span>=<span class="string">"textColorHighlight"</span>&gt;</span>?textColorHighlight<span class="tag">&lt;/<span class="name">item</span>&gt;</span></span></span><br><span class="line"><span class="xml">    <span class="tag">&lt;<span class="name">item</span> <span class="attr">name</span>=<span class="string">"textColorHint"</span>&gt;</span>?textColorHint<span class="tag">&lt;/<span class="name">item</span>&gt;</span></span></span><br><span class="line"><span class="xml">    <span class="tag">&lt;<span class="name">item</span> <span class="attr">name</span>=<span class="string">"textColorLink"</span>&gt;</span>?textColorLink<span class="tag">&lt;/<span class="name">item</span>&gt;</span></span></span><br><span class="line"><span class="xml">    <span class="tag">&lt;<span class="name">item</span> <span class="attr">name</span>=<span class="string">"textSize"</span>&gt;</span>16sp<span class="tag">&lt;/<span class="name">item</span>&gt;</span></span></span><br><span class="line"><span class="xml">    <span class="tag">&lt;<span class="name">item</span> <span class="attr">name</span>=<span class="string">"textStyle"</span>&gt;</span>normal<span class="tag">&lt;/<span class="name">item</span>&gt;</span></span></span><br><span class="line"><span class="undefined"></span><span class="tag">&lt;/<span class="name">style</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p><em>注,这里?就是?attr</em></p>
<p>这一类的attr是被其它attr引用， 进而影响到了UI。</p>
<h4 id="3-3-其它"><a href="#3-3-其它" class="headerlink" title="3.3 其它"></a>3.3 其它</h4><p>另外，还有window开头的attr, scrollbar, actionbar等attr，总之， 关于UI方面的任何一个地方， 在themes中是都为其指定了值的。</p>
<h2 id="三、结合style-theme-attr"><a href="#三、结合style-theme-attr" class="headerlink" title="三、结合style, theme, attr"></a>三、结合style, theme, attr</h2><p>以上分别讲了style, theme, attr. 下面通过自定义一个主题，学习如何编写这三个文件， 通过此，了解以下三点</p>
<ol>
<li>SDK中的theme,style,attr是如何组织的。</li>
<li>theme和style中的命名规范</li>
<li>正确使用theme和style</li>
</ol>
<p>一种主题就是一种UI风格， 涉及到UI下</p>
<ol>
<li>各组件的样式</li>
<li>UI的配色</li>
<li>字体</li>
</ol>
<p>我们就从这三个方面入手定义主题。</p>
<p>Step1: 首先，为我们的主题起一个名字，我们想该主题给人一种温暖的感觉， 所以就叫做Warm吧。</p>
<p>Step2: 定义attr，在此之前，需要确定系统中有哪几种Widget， 假设就两种， Button, TextView， 而且这两种没有继承关系。</p>
<p>那么，如何定义attr呢？我们定义的attr应该有两类， 一类是与Widget无关的， 一类是与Widget相关的。</p>
<p>比如说，可以这样</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">resources</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">declare-styleable</span> <span class="attr">name</span>=<span class="string">"Theme"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">attr</span> <span class="attr">name</span>=<span class="string">"colorPrimary"</span> <span class="attr">format</span>=<span class="string">”color</span>"/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">attr</span> <span class="attr">name</span>=<span class="string">"textColor"</span> <span class="attr">format</span>=<span class="string">"color"</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">attr</span> <span class="attr">name</span>=<span class="string">"fontFamily"</span> <span class="attr">format</span>=<span class="string">"string"</span>/&gt;</span></span><br><span class="line">        </span><br><span class="line">        <span class="tag">&lt;<span class="name">attr</span> <span class="attr">name</span>=<span class="string">"buttonStyle"</span> <span class="attr">format</span>=<span class="string">"reference"</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">attr</span> <span class="attr">name</span>=<span class="string">"textViewStyle"</span> <span class="attr">format</span>=<span class="string">"reference"</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">declare-styleable</span>&gt;</span></span><br><span class="line">    </span><br><span class="line">    <span class="tag">&lt;<span class="name">declare-styleable</span> <span class="attr">name</span>=<span class="string">"Button"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">attr</span> <span class="attr">name</span>=<span class="string">"roundCorner"</span> <span class="attr">format</span>=<span class="string">”boolean</span>"/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">attr</span> <span class="attr">name</span>=<span class="string">"textColor"</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">attr</span> <span class="attr">name</span>=<span class="string">"fontFamily"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">declare-styleable</span>&gt;</span></span><br><span class="line">    </span><br><span class="line">    <span class="tag">&lt;<span class="name">declare-styleable</span> <span class="attr">name</span>=<span class="string">"TextView"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">attr</span> <span class="attr">name</span>=<span class="string">"borderSize"</span> <span class="attr">format</span>=<span class="string">”dimension</span>"/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">attr</span> <span class="attr">name</span>=<span class="string">"textColor"</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">attr</span> <span class="attr">name</span>=<span class="string">"fontFamily"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">declare-styleable</span>&gt;</span></span><br><span class="line">    </span><br><span class="line"><span class="tag">&lt;/<span class="name">resources</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>以上， 定义了三个全局属性，为每个Widget定义了三个属于Widget的属性。</p>
<p>全局属性从名称可以看出来， 其并非属于某一特定的Widget， 如colorPrimary应用的主色调等。</p>
<p>好了， 接下来可以定义主题了</p>
<p>Step 3: 定义Warm主题Part1</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">style</span> <span class="attr">name</span>=<span class="string">"Theme.Warm"</span>&gt;</span><span class="undefined"></span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="undefined">    //全局属性设置</span></span><br><span class="line"><span class="xml">    <span class="tag">&lt;<span class="name">item="colorPrimary"</span>&gt;</span>#ee0000<span class="tag">&lt;/<span class="name">item</span>&gt;</span></span></span><br><span class="line"><span class="xml">    <span class="tag">&lt;<span class="name">item="textColor"</span>&gt;</span>#000000<span class="tag">&lt;/<span class="name">item</span>&gt;</span></span></span><br><span class="line"><span class="xml">    <span class="tag">&lt;<span class="name">item="fontFamily"</span>&gt;</span>Roboto Mono<span class="tag">&lt;/<span class="name">item</span>&gt;</span></span></span><br><span class="line"><span class="undefined">    </span></span><br><span class="line"><span class="undefined">    //这里我们似乎需要先定义Widget的样式</span></span><br></pre></td></tr></table></figure>
<p>这里的名字以Theme开头，说明这是一个Theme, 后面是Theme的风格名。</p>
<p>以上主题并没有定义完， 我们先转到Widget的样式定义上来。</p>
<p>Step 4: Widget样式定义</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">style</span> <span class="attr">name</span>=<span class="string">“Widget.Warm.Button</span>"&gt;</span><span class="undefined"></span></span><br><span class="line"><span class="xml">    <span class="tag">&lt;<span class="name">item="roundCorner"</span>&gt;</span>true<span class="tag">&lt;/<span class="name">item</span>&gt;</span></span></span><br><span class="line"><span class="xml">    <span class="tag">&lt;<span class="name">item="textColor"</span>&gt;</span>?attr/textColor<span class="tag">&lt;/<span class="name">item</span>&gt;</span></span></span><br><span class="line"><span class="xml">    <span class="tag">&lt;<span class="name">item="fontFamily"</span>&gt;</span>?attr/fontFamily<span class="tag">&lt;/<span class="name">item</span>&gt;</span></span></span><br><span class="line"><span class="undefined"></span><span class="tag">&lt;/<span class="name">style</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">style</span> <span class="attr">name</span>=<span class="string">“Widget.Warm.TextView</span>"&gt;</span><span class="undefined"></span></span><br><span class="line"><span class="xml">    <span class="tag">&lt;<span class="name">item="borderSize"</span>&gt;</span>1dp<span class="tag">&lt;/<span class="name">item</span>&gt;</span></span></span><br><span class="line"><span class="xml">    <span class="tag">&lt;<span class="name">item="textColor"</span>&gt;</span>?attr/textColor<span class="tag">&lt;/<span class="name">item</span>&gt;</span></span></span><br><span class="line"><span class="xml">    <span class="tag">&lt;<span class="name">item="fontFamily"</span>&gt;</span>?attr/fontFamily<span class="tag">&lt;/<span class="name">item</span>&gt;</span></span></span><br><span class="line"><span class="undefined"></span><span class="tag">&lt;/<span class="name">style</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>以上我们的命名规划是， 第一项Widget说明是一个Widget的样式， 第二项为风格名，第三项为Widget的名称。</p>
<p>而且其属性值都引用了theme中定义的全局属性值， 这样做是合理的， 因为textColor和fontFamily要保持和谐， 直接使用主题中的值是最好不过的了。</p>
<p>Step 5: 定义Warm主题Part2</p>
<p>接下来可以完成主题的第二部分定义了</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">style</span> <span class="attr">name</span>=<span class="string">"Theme.Warm"</span>&gt;</span><span class="undefined"></span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="undefined">    //全局属性设置</span></span><br><span class="line"><span class="xml">    <span class="tag">&lt;<span class="name">item="colorPrimary"</span>&gt;</span>#ee0000<span class="tag">&lt;/<span class="name">item</span>&gt;</span></span></span><br><span class="line"><span class="xml">    <span class="tag">&lt;<span class="name">item="textColor"</span>&gt;</span>#000000<span class="tag">&lt;/<span class="name">item</span>&gt;</span></span></span><br><span class="line"><span class="xml">    <span class="tag">&lt;<span class="name">item="fontFamily"</span>&gt;</span>Roboto Mono<span class="tag">&lt;/<span class="name">item</span>&gt;</span></span></span><br><span class="line"><span class="undefined">    </span></span><br><span class="line"><span class="undefined">    //定义Widget的样式</span></span><br><span class="line"><span class="xml">    <span class="tag">&lt;<span class="name">item="buttonStyle"</span>&gt;</span>@style/Widget.Warm.Button<span class="tag">&lt;/<span class="name">item</span>&gt;</span></span></span><br><span class="line"><span class="xml">    <span class="tag">&lt;<span class="name">item="textViewStyle"</span>&gt;</span>@style/Widget.Warm.TextView<span class="tag">&lt;/<span class="name">item</span>&gt;</span></span></span><br><span class="line"><span class="undefined">    </span></span><br><span class="line"><span class="undefined"></span><span class="tag">&lt;/<span class="name">style</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>Step 6: 总结</p>
<p>以上只是一个很简单的例子， 有很多不合理的地方，但基本说明了问题， SDK中的主题更加复杂，但基本组织结构与些类似。</p>
<h2 id="四，-好的实践"><a href="#四，-好的实践" class="headerlink" title="四， 好的实践"></a>四， 好的实践</h2><p>那么， 如何利用好themes styles attrs呢？</p>
<p>我们设计应用时，会首先确定应用的风格，如果要自定义风格， 就得像前面那样， 为每种Widget设计其风格，如果要使用SDK中的主题，如Material，则各种Widget已经有了相应风格。如果我们要对其进行定制， 那么怎么修改呢？</p>
<p>比如说， 我们对Theme.Material这个主题很满意， 除了它的buttonStyle的风格， 那么我们怎么修改呢？在哪里修改是最合适呢？</p>
<p>一种方法是自定义新的buttonStyle，然后在layout中利用style直接改， 这样，每有一个Button就必须有一个style引用，其麻烦之处就像第二节所讲的那样。</p>
<p>另一种方法是先找到主题中哪些attr影响了我们要修改的地方， 然后继承一个主题， 并复写该attr即可，比如说， 可以这样。</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">style</span> <span class="attr">name</span>=<span class="string">"CustomTheme"</span> <span class="attr">parent</span>=<span class="string">"@android:style/Theme.Material&gt;</span></span></span><br><span class="line"><span class="tag"><span class="string">    &lt;item name="</span><span class="attr">buttonStyle</span>”&gt;</span><span class="css">@<span class="keyword">style</span>/<span class="keyword">customButtonStyle</span>&lt;/<span class="keyword">item</span>&gt;</span></span><br><span class="line"><span class="undefined"></span><span class="tag">&lt;/<span class="name">style</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>如果说我们要对某一View进行一个简单的修改，如使一个背景色使用主题的主要色，这样更加和谐，在这里，应该引用theme的属性， 以体现和谐性。如</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">Button</span> <span class="attr">background</span>=<span class="string">"?attr/colorPrimary"</span>/&gt;</span></span><br></pre></td></tr></table></figure>
<p>而不是这样</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">Button</span> <span class="attr">background</span>=<span class="string">“@color/colorPrimary</span>"/&gt;</span></span><br></pre></td></tr></table></figure>
<p>所以， 所有的值尽量来自于theme， 这样会使得app有一种统一的风格。</p>
<h2 id="五、v7-appcompat-library"><a href="#五、v7-appcompat-library" class="headerlink" title="五、v7 appcompat library"></a>五、v7 appcompat library</h2><p>v7是经常使用的一个库， 在官网中有这样一句话</p>
<blockquote>
<p>There are several libraries designed to be used with Android 2.1 (API level 7) and higher. These libraries provide specific feature sets and can be included in your application independently from each other.</p>
</blockquote>
<p>即v7为低版本的SDK提供了Material Design的支持， 因为低版本的SDK中没有带Material Theme.</p>
<p>关于v7的使用， 记住最关键的一点</p>
<blockquote>
<p>v7中themes, styles, attrs的地位与你自定义的是一样的，都是属于第三方，即和SDK并不在同一个命名空间</p>
</blockquote>
<h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><ol>
<li><a href="http://blog.supenta.com/2014/06/15/how-to-avoid-headaches-with-android-themes-and-styles/" target="_blank" rel="noopener">How to avoid headaches with Android themes and styles</a></li>
<li><a href="https://m.oschina.net/blog/383552" target="_blank" rel="noopener">修改安卓默认的系统button样式，以及其它系统控件的默认样式</a></li>
<li><a href="https://chris.banes.me/2014/11/12/theme-vs-style/" target="_blank" rel="noopener">Theme vs Style</a></li>
<li><a href="http://stackoverflow.com/questions/3441396/defining-custom-attrs" target="_blank" rel="noopener">Defining custom attrs</a></li>
</ol>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://asanelder.me/2016/05/09/several-questions-about-volley/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="asanelder">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Code, Food & Music">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2016/05/09/several-questions-about-volley/" itemprop="url">关于Volley的几个问题</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2016-05-09T00:00:00+08:00">
                2016-05-09
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h3 id="1-Response是如何被传递给UI线程时"><a href="#1-Response是如何被传递给UI线程时" class="headerlink" title="1. Response是如何被传递给UI线程时"></a>1. Response是如何被传递给UI线程时</h3><p>在初始化一个RequestQueue时, 会注入一个ExecutorDelivery对象, 该对象持有一个Handler对象, 而Handler对象又持有主线程的Looper对象.如下代码所示</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">RequestQueue</span><span class="params">(Cache cache, Network network, <span class="keyword">int</span> threadPoolSize)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">this</span>(cache, network, threadPoolSize,</span><br><span class="line">            <span class="keyword">new</span> ExecutorDelivery(<span class="keyword">new</span> Handler(Looper.getMainLooper())));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>而该ExecutorDelivery对象又会被传递给RequestQueue管理的Dispatcher</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">start</span><span class="params">()</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Make sure any currently running dispatchers are stopped.</span></span><br><span class="line">    <span class="comment">// 启动之前将所有的dispatcher线程停止</span></span><br><span class="line">    stop();</span><br><span class="line">    <span class="comment">// Create the cache dispatcher and start it.</span></span><br><span class="line">    mCacheDispatcher = <span class="keyword">new</span> CacheDispatcher(mCacheQueue, mNetworkQueue,mCache, mDelivery);</span><br><span class="line">    mCacheDispatcher.start();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Create network dispatchers (and corresponding threads) up to thepool size.</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; mDispatchers.length; i++) &#123;</span><br><span class="line">        NetworkDispatcher networkDispatcher = <span class="keyword">new</span> NetworkDispatche(mNetworkQueue, mNetwork,</span><br><span class="line">                mCache, mDelivery);</span><br><span class="line">        mDispatchers[i] = networkDispatcher;</span><br><span class="line">        networkDispatcher.start();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Dispatcher就是工作者线程, 该线程的run()方法中调用mDelivery.postResponse(request, response)来发布response.</p>
<p>而所谓的发布仅仅是通过将response转换为Runnable对象后</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mResponsePoster.execute(<span class="keyword">new</span> ResponseDeliveryRunnable(request, response, <span class="keyword">null</span>));</span><br></pre></td></tr></table></figure>
<p>利用</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">handler.post(command);</span><br></pre></td></tr></table></figure>
<p>发送到主线程的消息队列中去</p>
<h3 id="2-如何判断一个请求正在被处理"><a href="#2-如何判断一个请求正在被处理" class="headerlink" title="2. 如何判断一个请求正在被处理"></a>2. 如何判断一个请求正在被处理</h3><p>其实这就是mCurrentRequests的作用之一. 当一个请求被处理后, 会调用Request的finish方法, 该方法又调用RequestQueue的finish方法, 而在该方法中, 有</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">synchronized</span> (mCurrentRequests) &#123;</span><br><span class="line">   mCurrentRequests.remove(request);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>说明当Request被处理完后, 会从mCurrentRequests中删除.</p>
<p>由此可见, 如果一个Request还没有从mCurrentRequests中删除,说明其依然还在处理当中.</p>
<h3 id="3-mCurrentRequests的作用是什么"><a href="#3-mCurrentRequests的作用是什么" class="headerlink" title="3. mCurrentRequests的作用是什么"></a>3. mCurrentRequests的作用是什么</h3><p>作用暂时有两点</p>
<ol>
<li>如问题2, 保存着所有正在被处理的Request</li>
<li><p>可用来取消正在被处理的Request. 如RequestQueue中的cancelAll代码</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">cancelAll</span><span class="params">(RequestFilter filter)</span> </span>&#123;</span><br><span class="line">	 <span class="keyword">synchronized</span> (mCurrentRequests) &#123;</span><br><span class="line">    	<span class="keyword">for</span> (Request&lt;?&gt; request : mCurrentRequests) &#123;</span><br><span class="line">        	<span class="keyword">if</span> (filter.apply(request)) request.cancel();</span><br><span class="line">    	&#125;</span><br><span class="line">	 &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ol>
<p>实际上, 取消操作不一定成功, 因为可能某一Dispatcher已经判断过isCanceled了.</p>
<h3 id="4-mWaitingRequests的作用是什么"><a href="#4-mWaitingRequests的作用是什么" class="headerlink" title="4. mWaitingRequests的作用是什么"></a>4. mWaitingRequests的作用是什么</h3><p>由RequestQueue的add方法代码</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// If the request is uncacheable, skip the cache queue and go straight to the network.</span></span><br><span class="line"><span class="keyword">if</span> (!request.shouldCache()) &#123;</span><br><span class="line">    mNetworkQueue.add(request);</span><br><span class="line">    <span class="keyword">return</span> request;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">synchronized</span> (mWaitingRequests) &#123;</span><br><span class="line">    String cacheKey = request.getCacheKey();</span><br><span class="line">    <span class="keyword">if</span> (mWaitingRequests.containsKey(cacheKey)) &#123;</span><br><span class="line">        <span class="comment">// There is already a request in flight. Queue up.</span></span><br><span class="line">        Queue&lt;Request&lt;?&gt;&gt; stagedRequests = mWaitingRequests.ge(cacheKey);</span><br><span class="line">        <span class="keyword">if</span> (stagedRequests == <span class="keyword">null</span>) &#123;</span><br><span class="line">            stagedRequests = <span class="keyword">new</span> LinkedList&lt;Request&lt;?&gt;&gt;();</span><br><span class="line">        &#125;</span><br><span class="line">        stagedRequests.add(request);</span><br><span class="line">        mWaitingRequests.put(cacheKey, stagedRequests);</span><br><span class="line">        <span class="keyword">if</span> (VolleyLog.DEBUG) &#123;</span><br><span class="line">            VolleyLog.v(<span class="string">"Request for cacheKey=%s is in flight, puttingonhold."</span>, cacheKey);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// Insert 'null' queue for this cacheKey, indicating there isnow arequest in</span></span><br><span class="line">        <span class="comment">// flight.</span></span><br><span class="line">        mWaitingRequests.put(cacheKey, <span class="keyword">null</span>);</span><br><span class="line">        mCacheQueue.add(request);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> request;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>以及, RequestQueue的finish方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (request.shouldCache()) &#123;</span><br><span class="line">    <span class="keyword">synchronized</span> (mWaitingRequests) &#123;</span><br><span class="line">        String cacheKey = request.getCacheKey();</span><br><span class="line">        Queue&lt;Request&lt;?&gt;&gt; waitingRequests = mWaitingRequests.remo(cacheKey);</span><br><span class="line">        <span class="keyword">if</span> (waitingRequests != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (VolleyLog.DEBUG) &#123;</span><br><span class="line">                VolleyLog.v(<span class="string">"Releasing %d waiting requestsforcacheKey=%s."</span>,</span><br><span class="line">                        waitingRequests.size(), cacheKey);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// Process all queued up requests. They won't beconsidered asin flight, but</span></span><br><span class="line">            <span class="comment">// that's not a problem as the cache has been primedby'request'.</span></span><br><span class="line">            mCacheQueue.addAll(waitingRequests);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>可知, mWaitingRequests保存着具有相同cacheKey的所有Request, 而在Request被finish时, 具有相同cacheKey的Request会被加入到mCacheQueue中, 那么, 为什么不把相同cacheKey的Request直接加入到mCacheQueue, 而必须要等到某一Request被finish之后才加入呢?</p>
<p>假如直接加入到mCacheQueue, 我们知道第一个Request还未被Cache, 所以会交给NetworkDispatcher来处理, 如果NetworkDispatcher还未处理, 又来了几个相同cacheKey的Request, 那么因为NetworkDispatcher还未处理, 所以还未被cache, 所以这些Request就都会被加到到NetworkDispatcher的处理队列, 就起不到Cache的作用了.</p>
<p>而如果等待第一个Request被finish后, 再加入, 则因为Request被finish说明其已经被处理, 则已被Cache.</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
  </section>

  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/page/3/"><i class="fa fa-angle-left"></i></a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/3/">3</a><span class="page-number current">4</span><a class="page-number" href="/page/5/">5</a><span class="space">&hellip;</span><a class="page-number" href="/page/17/">17</a><a class="extend next" rel="next" href="/page/5/"><i class="fa fa-angle-right"></i></a>
  </nav>



          </div>
          


          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      

      <section class="site-overview-wrap sidebar-panel sidebar-panel-active">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <p class="site-author-name" itemprop="name">asanelder</p>
              <p class="site-description motion-element" itemprop="description"></p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives/">
              
                  <span class="site-state-item-count">84</span>
                  <span class="site-state-item-name">日志</span>
                </a>
              </div>
            

            

            
              
              
              <div class="site-state-item site-state-tags">
                
                  <span class="site-state-item-count">9</span>
                  <span class="site-state-item-name">标签</span>
                
              </div>
            

          </nav>

          

          
            <div class="links-of-author motion-element">
                
                  <span class="links-of-author-item">
                    <a href="https://github.com/lingnanlu" target="_blank" title="GitHub">
                      
                        <i class="fa fa-fw fa-github"></i>GitHub</a>
                  </span>
                
                  <span class="links-of-author-item">
                    <a href="https://instagram.com/lingnanlu" target="_blank" title="Instagram">
                      
                        <i class="fa fa-fw fa-instagram"></i>Instagram</a>
                  </span>
                
            </div>
          

          
          

          
          

          

        </div>
      </section>

      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2019</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">asanelder</span>

  
</div>


  <div class="powered-by">由 <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a> 强力驱动</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">主题 &mdash; <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Pisces</a> v5.1.4</div>




        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.1.4"></script>



  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script>



  


  




	





  





  












  





  

  

  

  
  

  

  

  

</body>
</html>
